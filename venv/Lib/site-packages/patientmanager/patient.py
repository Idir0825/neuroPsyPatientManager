""" File patient in the library neuropsy made to manage the patients of the application NeuroPsyPatientManager """

import os
from pathlib import Path
import json
import logging
from glob import glob
import datetime as dt
import uuid

PATIENTS_PATH = os.path.join(Path.home(), ".patients")


def get_patients():
    """
        Returns a list of all the patients contained in the PATIENTS_PATH
    """
    if not os.path.exists(PATIENTS_PATH):
        logging.error(f"Aucun patient n'a été créé à l'heure actuelle, le chemin {PATIENTS_PATH} n'existe pas.")
        return False

    patients_list = []
    files = glob(os.path.join(PATIENTS_PATH, "*.json"))
    for file in files:
        with open(file, "r") as f:
            data = json.load(f)
            guid = os.path.splitext(os.path.basename(file))[0]
            last_name = data.get('last_name')
            first_name = data.get('first_name')
            birth_date = data.get('birth_date')
            notes = data.get('notes')
            passation_dates = data.get('passation_dates')
            creation_date = data.get('creation_date')
            patient = Patient(guid=guid,
                              last_name=last_name,
                              first_name=first_name,
                              birth_date=birth_date,
                              notes=notes,
                              passation_dates=passation_dates,
                              creation_date=creation_date)
            patients_list.append(patient)

    return patients_list


class Patient:
    """ Creates an instance of a Patient """

    def __init__(self, guid="", last_name="", first_name="", birth_date="", notes={}, passation_dates={},
                 creation_date=""):
        """
        Constructor for the class patient.

        :param guid: unique universal identifier of the patient
        :param last_name: name of the patient
        :param first_name: first name of the patient
        :param birth_date: birthdate of the patient
        :param notes: all the notes that the patient got for any test that he passed
        :param passation_dates: all the dates at which the patient passed any test
        """

        if not guid:
            self.id = str(uuid.uuid4())
        else:
            self.id = guid

        self.last_name = last_name
        self.first_name = first_name
        self.birth_date = birth_date
        self.notes = notes
        self.passation_dates = passation_dates

        if not creation_date:
            self.created_on = dt.datetime.today().strftime("%d-%m-%Y")
        elif type(creation_date) is not str:
            raise Exception(
                    f"Le type de creation_date doit être str pour le patient {self.last_name} {self.first_name}.")
        else:
            self.created_on = creation_date

    def __str__(self):
        return f"Le patient {self.last_name} " \
               f"{self.first_name} né le {self.birth_date}"

    def __repr__(self):
        return f"{self.last_name} {self.first_name} ({self.id})"

    def delete(self):
        """
        Deletes the patient from the Disc

        :return: False if the suppression was not completed, True if the suppression was a success
        """

        os.remove(self.path)
        if os.path.exists(self.path):
            logging.error(f"Le/la patient(e) {self.last_name} {self.first_name} n'a pas pu être supprimé(e).")
            return False

        logging.info(f"Le/la patient(e) {self.last_name} {self.first_name} a bien été supprimé(e).")
        return True

    @property
    def path(self):
        """"
        Property containing the path to the patient's file

        :return: The path to the patient's file
        """
        return os.path.join(PATIENTS_PATH, self.id + ".json")

    def save(self):
        """
        Saves the patient in the path defined by the variable self.path

        :return: True if the patient was saved successfully, else returns False
        """
        try:
            if not os.path.exists(PATIENTS_PATH):
                os.makedirs(PATIENTS_PATH)

            data = {"last_name":       self.last_name, "first_name": self.first_name,
                    "birth_date":      self.birth_date, "notes": self.notes,
                    "passation_dates": self.passation_dates, "creation_date": self.created_on
                    }

            with open(self.path, "w") as f:
                json.dump(data, f, indent=4)
                logging.info(f"Le/la patient(e) {self.last_name} {self.first_name} a bien été mis(e) à jour.")
            return True

        except Exception as e:
            print(e)
            logging.error(f"Le/la patient(e) n'a pas pu être enregistré(e)")
            return False
